name: Push index.html to Target Repo Folder (Using Deploy Key)

on:
  push:
    branches: [ main ]
    paths:
      - 'index.html'
  workflow_dispatch:

jobs:
  push-html-to-folder:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4

      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_KEY }}

      - name: Configure Git User
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      - name: Clone target repository
        env:
          TARGET_REPO_SSH: "git@github.com:Eclair-Official/nav.git"
        run: |
          # 克隆时只拉取目标分支，这会更高效且避免混淆
          git clone --single-branch --branch ${TARGET_BRANCH} ${TARGET_REPO_SSH} target-repo
        env:
          TARGET_BRANCH: "gh-pages" # 定义目标分支

      - name: Prepare folder and copy index.html
        env:
          SOURCE_REPO_NAME: ${{ github.event.repository.name }}
        run: |
          mkdir -p ./target-repo/pages/${SOURCE_REPO_NAME}
          cp ./index.html ./target-repo/pages/${SOURCE_REPO_NAME}/

      # --- 以下是最终修正的核心步骤 ---
      - name: Commit and push changes
        env:
          TARGET_BRANCH: "gh-pages"
          SOURCE_REPO_NAME: ${{ github.event.repository.name }}
        run: |
          # 进入目标仓库目录
          cd target-repo
          
          # 1. 检查是否有文件变更
          #    因为克隆时已经位于 gh-pages 分支，所以无需 checkout
          if [ -n "$(git status --porcelain)" ]; then
            echo "ℹ️ Changes detected on branch '${TARGET_BRANCH}', preparing to push."
            
            # 2. 添加并提交变更
            git add .
            git commit -m "Update ${SOURCE_REPO_NAME}/index.html from source repo @ ${{ github.sha }}"
            
            # 3. 推送变更
            #    因为我们是从最新的远程分支开始操作的，并且没有其他人修改这个分支，
            #    所以一个简单的 git push 就足够了。如果担心并发修改，可以保留 pull --rebase。
            git push origin ${TARGET_BRANCH}
            
            echo "✅ Successfully pushed ${SOURCE_REPO_NAME}/index.html to the ${TARGET_BRANCH} branch."
          else
            echo "ℹ️ No changes to commit. Skipping push."
          fi
