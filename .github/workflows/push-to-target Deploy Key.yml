name: Deploy to Target Repo (Optimized Method)

on:
  push:
    branches: [ main ]
    paths:
      - 'index.html'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    # 需要写入权限，以便 Runner 可以推送代码到目标仓库
    permissions:
      contents: write

    steps:
      # 步骤 1: 检出源代码
      - name: Checkout source code
        uses: actions/checkout@v4

      # 步骤 2: 检出目标仓库 (使用 deploy key 认证)
      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: Eclair-Official/nav # 替换为你的目标仓库，例如 "my-org/my-docs"
          token: ${{ secrets.DEPLOY_KEY }} # 使用 Deploy Key 对应的 Secret
          path: target-repo # 将目标仓库检出到 'target-repo' 目录
          ref: gh-pages # 直接检出 gh-pages 分支

      # 步骤 3: 复制文件到目标仓库目录
      - name: Copy file to target repository
        env:
          SOURCE_REPO_NAME: ${{ github.event.repository.name }}
        run: |
          mkdir -p ./target-repo/pages/${SOURCE_REPO_NAME}
          cp ./index.html ./target-repo/pages/${SOURCE_REPO_NAME}/
          echo "✅ File copied to workspace."

      # 步骤 4: 提交并推送到目标仓库
      - name: Commit and push changes
        run: |
          cd target-repo
          # 在 Runner 环境配置 Git 用户信息
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # 检查是否有变更
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "feat: Update ${SOURCE_REPO_NAME}/index.html from source repo"
            git push origin gh-pages
            echo "✅ Deployment to target repo successful!"
          else
            echo "ℹ️ No changes to deploy."
          fi
