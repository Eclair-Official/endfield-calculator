name: Push index.html to Target Repo Folder (Using Deploy Key)

on:
  push:
    branches: [ main ]
    paths:
      - 'index.html'
  workflow_dispatch:

jobs:
  push-html-to-folder:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4

      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_KEY }}

      - name: Configure Git User
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      - name: Clone target repository
        env:
          TARGET_REPO_SSH: "git@github.com:Eclair-Official/nav.git"
        run: |
          # 克隆目标仓库，并指定深度为 1 以加快速度
          git clone --depth 1 ${TARGET_REPO_SSH} target-repo

      - name: Prepare folder and copy index.html
        env:
          SOURCE_REPO_NAME: ${{ github.event.repository.name }}
        run: |
          mkdir -p ./target-repo/pages/${SOURCE_REPO_NAME}
          cp ./index.html ./target-repo/pages/${SOURCE_REPO_NAME}/

      # --- 以下是修改和优化的核心步骤 ---
      - name: Sync changes and push to target repository
        env:
          TARGET_BRANCH: "gh-pages"
          SOURCE_REPO_NAME: ${{ github.event.repository.name }}
        run: |
          # 进入目标仓库目录
          cd target-repo
          
          # 1. 检查是否有文件变更
          if [ -n "$(git status --porcelain)" ]; then
            echo "ℹ️ Changes detected, preparing to push."
            
            # 2. 添加并提交变更
            git add .
            git commit -m "Update ${SOURCE_REPO_NAME}/index.html from source repo @ ${{ github.sha }}"
            
            # 3. 拉取远程分支的最新代码并与本地合并
            #    git pull origin <branch_name> 会自动尝试 merge 或 rebase
            #    使用 --rebase 可以保持提交历史的线性，更清晰
            #    如果远程有冲突，rebase 会在这里失败，整个 job 会失败，这是正确的
            git pull origin ${TARGET_BRANCH} --rebase
            
            # 4. 推送合并后的代码
            #    经过 rebase 后，本地分支已经包含了远程的最新代码，可以正常推送
            git push origin ${TARGET_BRANCH}
            
            echo "✅ Successfully pushed ${SOURCE_REPO_NAME}/index.html to the ${TARGET_BRANCH} branch."
          else
            echo "ℹ️ No changes to commit. Skipping push."
          fi
