name: Push index.html to Target Repo Folder (Using Deploy Key)

on:
  push:
    branches: [ main ]
    paths:
      - 'index.html'
  workflow_dispatch:

jobs:
  push-html-to-folder:
    runs-on: ubuntu-latest
    steps:
      # 步骤1：拉取源仓库（当前仓库）
      - name: Checkout source repo
        uses: actions/checkout@v4

      # 步骤2：(新增) 设置 SSH 客户端和密钥
      - name: Setup SSH Key and Git Config
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "${DEPLOY_KEY}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan github.com >> ~/.ssh/known_hosts
          
          # 配置 Git 用户信息
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      # 步骤3：(修改) 使用 SSH 克隆目标仓库
      - name: Clone target repository using SSH
        env:
          # 注意这里的 URL 格式是 git@github.com:...
          TARGET_REPO_SSH: "git@github.com:Eclair-Official/nav.git"
        run: |
          git clone ${TARGET_REPO_SSH} target-repo

      # 步骤4：创建源仓库名文件夹 + 复制index.html
      - name: Create folder and copy index.html
        env:
          SOURCE_REPO_NAME: ${{ github.event.repository.name }}
        run: |
          mkdir -p ./target-repo/pages/${SOURCE_REPO_NAME}
          cp ./index.html ./target-repo/pages/${SOURCE_REPO_NAME}/

      # 步骤5：切换到目标分支并推送到目标仓库
      - name: Push to target repository
        env:
          TARGET_BRANCH: "gh-pages"
          SOURCE_REPO_NAME: ${{ github.event.repository.name }}
        run: |
          cd target-repo
          git checkout ${TARGET_BRANCH} || git checkout -b ${TARGET_BRANCH}
          
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "Update ${SOURCE_REPO_NAME}/index.html from source repo: ${{ github.sha }}"
            # 注意：使用 Deploy Key 后，推送不再需要 force-with-lease
            # 推荐使用普通推送，更安全
            git push origin ${TARGET_BRANCH}
            echo "✅ ${SOURCE_REPO_NAME}/index.html 已推送到目标仓库的 ${TARGET_BRANCH} 分支！"
          else
            echo "ℹ️ 无文件变更，无需推送"
          fi
