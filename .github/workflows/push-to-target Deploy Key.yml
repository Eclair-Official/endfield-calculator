# æ–‡ä»¶å: .github/workflows/deploy.yml

name: Deploy index.html to Target Repo

on:
  # å½“ main åˆ†æ”¯çš„ index.html æ–‡ä»¶æœ‰æ¨é€æ—¶è§¦å‘
  push:
    branches: [ main ]
    paths:
      - 'index.html'
  # å…è®¸åœ¨ Actions é¡µé¢æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      # ä¸ºäº†èƒ½å‘å…¶ä»–ä»“åº“æ¨é€ï¼Œéœ€è¦å†™å…¥ contents æƒé™
      contents: write

    steps:
      # æ­¥éª¤ 1: æ£€å‡ºæºä»“åº“ä»£ç 
      - name: Checkout source repository
        uses: actions/checkout@v4

      # æ­¥éª¤ 2: è®¾ç½® SSH å’Œ Git ç¯å¢ƒ
      - name: Setup SSH and Git environment
        env:
          # ä»æºä»“åº“çš„ Secrets ä¸­è¯»å–ç§é’¥
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
          # ä»æºä»“åº“çš„ Secrets ä¸­è¯»å–ç›®æ ‡ä»“åº“çš„ SSH URL
          # æ ¼å¼åº”ä¸º: git@github.com:OWNER/REPO_NAME.git
          TARGET_REPO_SSH: ${{ secrets.TARGET_REPO_SSH }}
        run: |
          # --- å¥å£®æ€§æ£€æŸ¥ï¼šç¡®ä¿å¿…è¦çš„ Secrets å­˜åœ¨ ---
          if [ -z "$DEPLOY_KEY" ]; then
            echo "âŒ Error: DEPLOY_KEY secret is not set or is empty."
            echo "Please check your repository's secrets."
            exit 1
          fi
          if [ -z "$TARGET_REPO_SSH" ]; then
            echo "âŒ Error: TARGET_REPO_SSH secret is not set or is empty."
            echo "Please check your repository's secrets."
            exit 1
          fi

          echo "âœ… Secrets found. Setting up SSH environment."
          
          # åˆ›å»º .ssh ç›®å½•
          mkdir -p ~/.ssh
          # å°†ç§é’¥å†™å…¥æ–‡ä»¶
          echo "${DEPLOY_KEY}" > ~/.ssh/deploy_key
          # è®¾ç½®ç§é’¥æ–‡ä»¶æƒé™ (SSHè¦æ±‚)
          chmod 600 ~/.ssh/deploy_key
          # æ·»åŠ  GitHub åˆ° known_hostsï¼Œé¿å…äº¤äº’å¼ç¡®è®¤
          ssh-keyscan github.com >> ~/.ssh/known_hosts

          # é…ç½® Git ç”¨æˆ·ä¿¡æ¯
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # æ­¥éª¤ 3: å…‹éš†ç›®æ ‡ä»“åº“
      - name: Clone target repository
        env:
          TARGET_REPO_SSH: ${{ secrets.TARGET_REPO_SSH }}
        run: |
          git clone ${TARGET_REPO_SSH} target-repo

      # æ­¥éª¤ 4: å¤åˆ¶æ–‡ä»¶åˆ°ç›®æ ‡ä»“åº“çš„æŒ‡å®šç›®å½•
      - name: Copy index.html to target folder
        env:
          # è‡ªåŠ¨è·å–æºä»“åº“å
          SOURCE_REPO_NAME: ${{ github.event.repository.name }}
        run: |
          # åˆ›å»ºç›®æ ‡ç›®å½•ï¼Œ-p é€‰é¡¹ä¿è¯å³ä½¿ç›®å½•å­˜åœ¨ä¹Ÿä¸ä¼šæŠ¥é”™
          mkdir -p ./target-repo/pages/${SOURCE_REPO_NAME}
          # å¤åˆ¶ index.html åˆ°ç›®æ ‡ç›®å½•
          cp ./index.html ./target-repo/pages/${SOURCE_REPO_NAME}/
          echo "ğŸ“ Copied index.html to target-repo/pages/${SOURCE_REPO_NAME}/"

      # æ­¥éª¤ 5: æ£€æŸ¥å˜æ›´å¹¶æ¨é€åˆ°ç›®æ ‡ä»“åº“
      - name: Check for changes and push
        env:
          TARGET_BRANCH: "gh-pages"
          SOURCE_REPO_NAME: ${{ github.event.repository.name }}
        run: |
          cd target-repo
          
          # åˆ‡æ¢åˆ°ç›®æ ‡åˆ†æ”¯ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º
          git checkout ${TARGET_BRANCH} || git checkout -b ${TARGET_BRANCH}
          
          # æ£€æŸ¥å·¥ä½œåŒºæ˜¯å¦æœ‰æœªæäº¤çš„å˜æ›´
          if [ -n "$(git status --porcelain)" ]; then
            echo "ğŸš€ Changes detected. Committing and pushing..."
            git add .
            # æäº¤å˜æ›´ï¼ŒåŒ…å«æºä»“åº“çš„ commit SHA ä»¥ä¾¿è¿½æº¯
            git commit -m "chore: Update ${SOURCE_REPO_NAME}/index.html from source repo: ${{ github.sha }}"
            # æ¨é€åˆ°è¿œç¨‹åˆ†æ”¯ã€‚ä½¿ç”¨ Deploy Key åä¸å†éœ€è¦ force
            git push origin ${TARGET_BRANCH}
            echo "âœ… Successfully pushed to ${TARGET_BRANCH}!"
          else
            echo "â„¹ï¸ No changes to commit. Nothing to do."
          fi
