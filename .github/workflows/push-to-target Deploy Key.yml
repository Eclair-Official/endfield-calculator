name: Push index.html to Target Repo Folder (Using Deploy Key)

on:
  push:
    branches: [ main ]
    paths:
      - 'index.html'
  workflow_dispatch:
  # 添加定时执行触发器
  schedule:
    # Cron 表达式: "分 时 日 月 周"
    # 示例: "0 2 * * *" 表示每天 UTC 时间凌晨 2:00 执行一次
    # 你可以使用 https://crontab.guru/ 来验证你的 Cron 表达式
    - cron: "0 2 * * *"

# 显式声明权限，最佳实践
permissions:
  contents: read

jobs:
  push-html-to-folder:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4
        # 对于定时任务，需要确保拉取到最新代码
        # fetch-depth: 0 获取完整历史，但对于仅比较文件内容，默认深度通常足够
        # 如果源仓库有复杂的分支结构，可以考虑使用
        # fetch-depth: 0

      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_KEY }}

      - name: Configure Git User
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      - name: Clone target repository
        env:
          TARGET_REPO_SSH: "git@github.com:Eclair-Official/nav.git"
          TARGET_BRANCH: "gh-pages"
        run: |
          # 直接克隆目标分支，并指定深度为 1 以加快速度
          git clone --depth 1 --branch ${TARGET_BRANCH} ${TARGET_REPO_SSH} target-repo

      - name: Prepare folder and copy index.html
        env:
          SOURCE_REPO_NAME: ${{ github.event.repository.name }}
        run: |
          mkdir -p ./target-repo/pages/${SOURCE_REPO_NAME}
          cp ./index.html ./target-repo/pages/${SOURCE_REPO_NAME}/

      - name: Sync changes and push to target repository
        env:
          TARGET_BRANCH: "gh-pages"
          SOURCE_REPO_NAME: ${{ github.event.repository.name }}
        run: |
          cd target-repo
          
          # 1. 检查是否有文件变更
          if [ -n "$(git status --porcelain)" ]; then
            echo "ℹ️ Changes detected, preparing to push."
            
            # 2. 添加并提交变更
            git add .
            git commit -m "Sync ${SOURCE_REPO_NAME}/index.html from source repo @ ${{ github.sha }}"
            
            # 3. 拉取远程分支的最新代码并与本地合并（rebase）
            git pull origin ${TARGET_BRANCH} --rebase
            
            # 4. 推送合并后的代码
            git push origin ${TARGET_BRANCH}
            
            echo "✅ Successfully pushed ${SOURCE_REPO_NAME}/index.html to the ${TARGET_BRANCH} branch."
          else
            echo "ℹ️ No changes to commit. Skipping push."
          fi
