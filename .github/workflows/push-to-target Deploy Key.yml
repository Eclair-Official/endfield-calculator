# .github/workflows/deploy.yml

name: Push index.html to Target Repo Folder (Optimized)

on:
  push:
    branches: [ main ]
    paths:
      - 'index.html'
  workflow_dispatch:

# 全局环境变量，方便统一维护
env:
  TARGET_REPO: "Eclair-Official/nav"
  TARGET_BRANCH: "gh-pages"

jobs:
  push-html-to-folder:
    runs-on: ubuntu-latest
    permissions:
      # 需要读取源仓库内容
      contents: read

    steps:
      # 步骤1：拉取源仓库（当前仓库）
      - name: Checkout source repo
        uses: actions/checkout@v4

      # 步骤2：克隆目标仓库 (使用 Deploy Key 认证)
      - name: Clone target repository
        run: |
          # 使用 SSH 协议和 Deploy Key 进行认证
          # GIT_SSH_COMMAND 环境变量可以临时指定 ssh key
          GIT_SSH_COMMAND="ssh -i ${{ secrets.DEPLOY_KEY }}" git clone git@github.com:${{ env.TARGET_REPO }}.git target-repo

      # 步骤3：创建源仓库名文件夹 + 复制index.html（核心步骤）
      - name: Create folder and copy index.html
        env:
          SOURCE_REPO_NAME: ${{ github.event.repository.name }}
        run: |
          mkdir -p ./target-repo/pages/${SOURCE_REPO_NAME}
          cp ./index.html ./target-repo/pages/${SOURCE_REPO_NAME}/
          echo "✅ File copied successfully."

      # 步骤4：提交并推送到目标仓库
      - name: Commit and push to target repository
        run: |
          cd target-repo
          
          # 为本次推送配置 Git 身份
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # 检查并切换到目标分支（你的写法很棒，保留）
          git checkout ${{ env.TARGET_BRANCH }} || git checkout -b ${{ env.TARGET_BRANCH }}
          
          # 检查是否有变更，避免空提交
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "docs: update pages/${{ env.SOURCE_REPO_NAME }}/index.html"
            
            # 再次使用 Deploy Key 进行推送
            GIT_SSH_COMMAND="ssh -i ${{ secrets.DEPLOY_KEY }}" git push origin ${{ env.TARGET_BRANCH }}
            
            echo "✅ Changes pushed to ${{ env.TARGET_REPO }} on branch ${{ env.TARGET_BRANCH }}!"
          else
            echo "ℹ️ No changes to commit. Skipping push."
          fi
