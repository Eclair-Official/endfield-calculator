name: Push index.html to Target Repo Folder

on:
  # 1. 原有的文件变更触发
  push:
    branches: [ main ]
    paths:
      - 'index.html'  

  # 2. 手动触发测试
  workflow_dispatch:

  # 3. 新增的定时触发
  schedule:
    # --- 示例：每天北京时间上午 9:00 (UTC 1:00) 运行 ---
    # cron格式：分钟 小时 日 月 星期
    # '0 1 * * *' 表示每天 UTC 1:00
    - cron: '0 1 * * *'

jobs:
  push-html-to-folder:
    runs-on: ubuntu-latest
    steps:
      # 步骤1：拉取源仓库（当前仓库）
      - name: Checkout source repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      # 步骤2：配置Git身份
      - name: Set Git credentials
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      # 步骤3：克隆目标仓库
      - name: Clone target repository
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
          TARGET_REPO: "Eclair-Official/nav"  
        run: |
          git clone https://${PAT_TOKEN}@github.com/${TARGET_REPO}.git target-repo

      # 步骤4：创建源仓库名文件夹 + 复制index.html
      - name: Create folder and copy index.html
        env:
          SOURCE_REPO_NAME: ${{ github.event.repository.name }}
        run: |
          mkdir -p ./target-repo/pages/${SOURCE_REPO_NAME}
          cp ./index.html ./target-repo/pages/${SOURCE_REPO_NAME}/

      # 步骤5：切换到目标分支并推送到目标仓库
      - name: Push to target repository
        env:
          TARGET_BRANCH: "gh-pages"  
          SOURCE_REPO_NAME: ${{ github.event.repository.name }}
        run: |
          cd target-repo
          git checkout ${TARGET_BRANCH} || git checkout -b ${TARGET_BRANCH}
          
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "Update ${SOURCE_REPO_NAME}/index.html from source repo: ${{ github.sha }}"
            git push origin ${TARGET_BRANCH} --force-with-lease
            echo "✅ ${SOURCE_REPO_NAME}/index.html 已推送到目标仓库的 ${TARGET_BRANCH} 分支！"
          else
            echo "ℹ️ 无文件变更，无需推送"
          fi
